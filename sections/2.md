# Раздел 2
## 9.
##### Что такое файловый дескриптор?
> **Файловый дескриптор** — это неотрицательное число, которое является идентификатором потока ввода-вывода. Дескриптор может быть связан с файлом, каталогом, сокетом.

Стандартные файловые дескрипторы
0. поток ввода
1. поток вывода
2. поток ошибок
##### Расскажите про сисколлы open, close и lseek для работы с файлами.
###### open
> int open(const char* pathname, int flags \[, mode_t mode])
> int creat(const char* pathname, mode_t mode)
- есть openat и openat2 - принимают дополнительный аргумент int dirfd
- можно получить новый файловый дескриптор при помощи open
```c++
int main() {
  int fd = open("./input.txt", O_RDONLY);
  char buff[100];
  read(fd, buf, 10);
  write(1, buf, 10);
}
```
###### close
> int close(int fd)
###### lseek
> off_t lseek(int fd, off_t offeset, int whence)
- задает отступ при чтении из файла/запись
##### Что произойдет, если сделать lseek на позицию больше чем размер файла и записать туда что-либо?
```c++
int main() {  
  int fd = open("./output.txt", O_WRONLY|O_CREAT);  
  int offset = lseek(fd, 50, SEEK_SET);  
  const char* buf = "Hello world";  
  int res = write(fd, buf, 10);  
  std::cout << res;  
}
```

```bash
cat output.txt #Hello worl
# размер output.txt 60 байт. Реально занимает 10
cp output.txt output2.txt
# пустота заполнится нулями, размер output2.txt - 60 и реально занимает 60
```
## <span style="background:rgba(163, 67, 31, 0.2)">10.</span>
##### Перенаправление ввода-вывода. Как в терминале направить вывод команды в файл с перезаписью файла? А без перезаписи, в режиме добавления в файл?
```bash
./a.out > result.txt # с перезаписью
./a.out >> result.txt # без перезаписи
```
##### Как перенаправить вывод одного из потоков (cout или cerr) в файл или в другой поток?
```bash
./a.out 1>output.txt
./a.out 1>&2
```
##### Как подавить вывод какого-то из потоков?
```
./a.out 1> /dev/null
```
##### Что делает команда tee?
tee дублирует вывод: записывает в поток вывода и в еще один указанный источник
```bash
./a.out | tee result.txt
```
##### Что делают сисколлы dup и dup2?
> int dup(int oldfd)
> int dup2(int oldfd, int newfd)
- возвращает новый файловый дескриптор, который будет указывать на то же самое, на что указывал старый
- занимает наименьший незанятый
- dup2 использует номер, который указан в newfd. Если newfd открыт, то он закрывается
  Пример: открыли файл, закрыли поток ввода (0), вызвали dup от 3. Теперь 0 указывает на то же самое, на что и 3
## 11.
##### Файловые системы. Что такое файловая система? Перечислите, какие наиболее популярные файловые системы существуют на сегодняшний день
>Файловая система — порядок, определяющий способ организации, хранения и именования данных на носителях информации. Информация, какая ФС на вашем жёстком диске записана где-то на нём. ОС знает где это и исходя из этих данных строит дерево файлов.

```bash
df -T -h # посмотреть тип своей файловой системы
```
Наиболее популярные файловые системы:
- Windows – **FAT**, NTFS, exFAT
- macOS – HFS, APFS, HFS+
- Linux – EXT2, EXT3, EXT4, XFS, JFS
##### Какие 6 видов файлов существуют в Linux?
1. обычные файлы
2. директории
3. символические ссылки
4. потоки (fifo)
5. сокеты
6. устройства (b/c) - блочные или символьные
##### Что из себя представляют директории с точки зрения файловой системы?
Директории - особый вид файлов, которые не занимают место на диске и имеют два имени: . и имя папки
##### Что такое inode и как узнать inode для файлов в данной директории?
inode - уникальный идентификатор для каждого файла. Благодаря inode файлы индексируются на диске.
```bash
ls -li
```
##### Что такое виртуальная файловая система? Покажите примеры файлов, которым не соответствует никакое дисковое пространство.
**Виртуальная файловая система (VFS) в Linux** — это абстрактный слой, который объединяет разные файловые системы в единое дерево каталогов и предоставляет универсальный интерфейс для работы с файлами, независимо от их типа (локальные, сетевые, виртуальные).
**Примеры**: большинство папок в корневой директории содержат виртуальные файлы, не занимающие пространство. Например (практически) все файлы в /proc, /dev/zero, /dev/null, /dev/random
##### Что такое swapfile?
В операционной системе Linux swapfile служит для временного хранения данных, которые не помещаются в RAM. Эти данные автоматически выгружаются из оперативной памяти в swapfile, чтобы освободить место для более приоритетных процессов.
## <span style="background:rgba(163, 67, 31, 0.2)">12.</span>
##### Как работает и какие сисколлы использует программа mv?
mv создает новое имя для inod'ы и забывает старое. Можно реализовать через сисколлы **link** и потом **unlink** или **rename**
##### Как работает и какие сисколлы использует программа rm?
rm работает противоположно ln, то есть забывает одно из имен для inod'ы.
Если останется 0 имен, то данные стираются с диска.
Использует сисколл **unlink**
## <span style="background:rgba(163, 67, 31, 0.2)">13.</span>
##### Жесткие и символические ссылки. В чем разница?
Особенности работы с **символическими** ссылками:
- при удалении/перемещении родительского файла становится битой
- при перемещении самой ссылки становится битой
- аналогично работе указателя в C++
  Особенности работы с **жесткими** ссылками:
- "другое название того же самого файла", аналогично работе ссылок в C++
- не может побиться
##### Как создать жесткую ссылку, символическую ссылку, что они представляют из себя с точки зрения файловой системы?
```bash
ln -s result.txt a.txt # символическая ссылка
ln result.txt a.txt # hard link - создаем новое
```
Символическая ссылка - особый тип файла, хранящий относительный путь к файлу, на который она ссылается
Жесткая ссылка - новое имя для той же самой inode
##### Как работает и какие сисколлы использует программа ln в случае создания жестких ссылок и символических ссылок?
Для символических ссылок вызывается **symlink**
Для жестких - **link**
## 14.
##### Права доступа к файлам. Как посмотреть, как изменить права доступа?
```bash
ls -l out.txt # посмотреть права доступа
chmod +x out.txt
можно задать права по
1. битовой маске
2. +x, +w, +r меняет права всем (user, group и other)
3. g+x меняет права для группы
```
##### Почему r и x - это разные права? Как понимать эти права доступа для директорий?
**r** - право на чтение, безопаснее чем право на выполнение
**x** - загрузить бинарный код как инструкцию к процессору
Для директорий:
**r** - позволяет вывести содержимое директории. Не запрещает оперировать с файлами, лежащими в директории, если известно имя
**x** - позволяет перейти в директорию. Без права на выполнение нельзя обращаться к файлам, лежащим в папке
##### Как поменять владельца файла, как поменять группу владельца?
```bash
chown root out.txt # поменять владельца файла
chgrp root out.txt # поменять группу
```
#####  Какие сисколлы используются для всего вышеперечисленного?
Для chown и chgrp - chown
Для chmod - chmod
##### Что такое suid-бит, что означают права доступа s и S у файла? Приведите примеры файлов, для которых нужно это право доступа.
**SUID-бит (Set User ID)** — это специальный бит в правах доступа файла в Linux/Unix, который позволяет запускать файл с правами владельца файла, а не того пользователя, который его выполняет. Это важно для выполнения задач, требующих повышенных привилегий.
1. s маленькая указывает, что SUID-бит установлен и файл **является исполняемым**
2. S большая - SUID-бит установлен, но файл **не является исполняемым** (т.е. отсутствует бит `x`). Чаще является ошибкой настройки.
   **Примеры:**
- /usr/bin/sudo, создавался суперпользователем и выполняется от лица root
- /usr/bin/passwd. Когда обычный пользователь запускает `passwd`, программа выполняется с правами `root`, чтобы иметь доступ к файлу `/etc/shadow`, где хранятся пароли.
```bash
chmod +s out.txt
```
## 15.
##### Как из терминала посмотреть, какие файловые дескрипторы сейчас открыты у данного процесса и какие файлы им соответствуют?
```bash
cd /proc/"proccess_id"/fd
ls -l
```
##### Как из терминала посмотреть, какие процессы сейчас держат открытым данный файл?
```bash
cat < /dev/zero
lsof /dev/zero
```
##### Как реализовать это на Си с помощью сисколлов (можно не приводить реализиацию полностью, только объяснить идею)?
###### 1.
Реализовать на C можно при помощи сисколов opendir /proc/"proccess_id"/fd. Потом обойти рекурсивно при помощи readdir. Подробные данные выводим благодаря stat
###### 2.
Можно обойти директории всех процессов /proc/"proccess_id"/fd и найти среди всех открытых файловых дескрипторов нужный файл (переход по символьным ссылкам осуществляется при помощи readlink)
## 16.
##### Блочные и символьные устройства. В чем разница? Приведите примеры того и другого.
- **Блочные** - необходимо записывать информацию блоками.
  **Пример:** /dev/nvme0n1 - жесткий диск
- **Символьные** обеспечивают непрерывный поток байт.
  **Пример:** /dev/zero - непрерывный поток нулей
##### Как прочитать данные с какого-нибудь символьного устройства, а также отправить данные на устройство?
Чтобы отправить данные на устройство или считать, нужно использовать обычные open, close, read, write, то есть обращаться с файлами устройств как с обычными. Это поддерживается механизмом виртуальной файловой системы.
##### Какие в Linux существуют виртуальные устройства и для чего они нужны?
> В Linux виртуальные устройства — это абстракции, которые представляют собой логические устройства, не связанные напрямую с физическим оборудованием.
- /dev/null - дыра. Используется для отбрасывания ненужного вывода
- /dev/zero - поток нулевых байт. Используется для инициализации памяти, создания пустых файлов
- /dev/random и /dev/urandom - поток рандомных байт
- аудио и видео устройства
- сетевые устройства
##### Что такое монтирование файловых систем?
> **Монтирование файловых систем** — это процесс подключения файловой системы (например, раздела жёсткого диска, флешки, сетевого ресурса или ISO-образа) к дереву каталогов операционной системы, чтобы сделать её содержимое доступным для использования.

В Linux (и других UNIX-подобных системах) дерево каталогов начинается с корня `/`, и каждая смонтированная файловая система становится частью этой структуры.
##### Как подмонтировать диск в файловую систему и как отмонтировать? Какие команды в терминале и какие сисколлы для этого используются?
```bash
df # позволяет посмотреть путь к устройству. /dev/sda1 например
sudo umount "изначальная точка" # сначала отмонтируем
sudo mount "путь к устройству" "точка монтирования"
```
Используются соответствующие сисколлы